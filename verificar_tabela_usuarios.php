<?php
// verificar_tabela_usuarios.php - Verificar estrutura da tabela usuarios

session_start();
require_once 'includes/db_connect.php';

echo "<h2>üîç VERIFICANDO TABELA USUARIOS</h2>";

// Verificar se o usu√°rio est√° logado
if (!isset($_SESSION['user_id'])) {
    echo "‚ùå Usu√°rio n√£o est√° logado. Fa√ßa login primeiro.<br>";
    exit();
}

$userId = $_SESSION['user_id'];
echo "‚úÖ Usu√°rio logado: ID $userId<br><br>";

// 1. Verificar estrutura da tabela usuarios
echo "<h3>1. Estrutura da Tabela 'usuarios'</h3>";

try {
    $stmt = $pdo->query("DESCRIBE usuarios");
    $colunas = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    echo "‚úÖ Tabela 'usuarios' existe<br>";
    echo "üìã Colunas da tabela:<br>";
    foreach ($colunas as $coluna) {
        echo "&nbsp;&nbsp;- {$coluna['Field']} ({$coluna['Type']})<br>";
    }
    
} catch (PDOException $e) {
    echo "‚ùå Erro ao verificar tabela usuarios: " . $e->getMessage() . "<br>";
}

echo "<hr>";

// 2. Verificar dados do usu√°rio atual
echo "<h3>2. Dados do Usu√°rio Atual</h3>";

try {
    $stmt = $pdo->prepare("SELECT * FROM usuarios WHERE id = ?");
    $stmt->execute([$userId]);
    $usuario = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($usuario) {
        echo "‚úÖ Usu√°rio encontrado<br>";
        echo "üìã Dados do usu√°rio:<br>";
        foreach ($usuario as $campo => $valor) {
            echo "&nbsp;&nbsp;- $campo: $valor<br>";
        }
    } else {
        echo "‚ùå Usu√°rio n√£o encontrado<br>";
    }
    
} catch (PDOException $e) {
    echo "‚ùå Erro ao buscar usu√°rio: " . $e->getMessage() . "<br>";
}

echo "<hr>";

// 3. Testar consulta corrigida
echo "<h3>3. Testando Consulta Corrigida</h3>";

try {
    // Primeiro, vamos ver quais colunas existem na tabela usuarios
    $stmt = $pdo->query("SHOW COLUMNS FROM usuarios");
    $colunas = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    $nomeColuna = null;
    foreach ($colunas as $coluna) {
        if (in_array($coluna['Field'], ['nome', 'nome_completo', 'name', 'full_name'])) {
            $nomeColuna = $coluna['Field'];
            break;
        }
    }
    
    if ($nomeColuna) {
        echo "‚úÖ Coluna de nome encontrada: $nomeColuna<br>";
        
        // Testar consulta com a coluna correta
        $stmt = $pdo->prepare("
            SELECT 
                c.*,
                cm.papel,
                cm.status as status_membro,
                u.$nomeColuna as nome_proprietario
            FROM contas c
            JOIN conta_membros cm ON c.id = cm.conta_id
            LEFT JOIN usuarios u ON c.criado_por = u.id
            WHERE cm.usuario_id = ? AND cm.status = 'ativo'
            ORDER BY c.data_criacao DESC
        ");
        $stmt->execute([$userId]);
        $contasUsuario = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        echo "‚úÖ Consulta executada com sucesso<br>";
        echo "üìä Contas encontradas: " . count($contasUsuario) . "<br>";
        
        if (!empty($contasUsuario)) {
            echo "üìã Contas do usu√°rio:<br>";
            foreach ($contasUsuario as $conta) {
                echo "&nbsp;&nbsp;- ID: {$conta['id']}, Nome: {$conta['nome']}, Propriet√°rio: {$conta['nome_proprietario']}<br>";
            }
        }
        
    } else {
        echo "‚ùå Nenhuma coluna de nome encontrada<br>";
        echo "üìã Colunas dispon√≠veis:<br>";
        foreach ($colunas as $coluna) {
            echo "&nbsp;&nbsp;- {$coluna['Field']}<br>";
        }
    }
    
} catch (PDOException $e) {
    echo "‚ùå Erro na consulta corrigida: " . $e->getMessage() . "<br>";
}

echo "<hr>";

// 4. Resumo e solu√ß√£o
echo "<h2>üìä RESUMO E SOLU√á√ÉO</h2>";

if ($nomeColuna) {
    echo "<div style='background: #d4edda; padding: 1rem; border-radius: 8px; margin: 1rem 0;'>";
    echo "<h4>‚úÖ PROBLEMA IDENTIFICADO E SOLU√á√ÉO</h4>";
    echo "<p><strong>Problema:</strong> A consulta estava tentando acessar 'u.nome' mas a coluna correta √© 'u.$nomeColuna'</p>";
    echo "<p><strong>Solu√ß√£o:</strong> Atualizar a consulta para usar '$nomeColuna' em vez de 'nome'</p>";
    echo "<p><strong>Pr√≥ximo passo:</strong> Corrigir os arquivos que fazem essa consulta</p>";
    echo "</div>";
} else {
    echo "<div style='background: #f8d7da; padding: 1rem; border-radius: 8px; margin: 1rem 0;'>";
    echo "<h4>‚ùå PROBLEMA MAIS COMPLEXO</h4>";
    echo "<p>A tabela usuarios n√£o possui uma coluna de nome padr√£o.</p>";
    echo "<p><strong>Poss√≠veis solu√ß√µes:</strong></p>";
    echo "<ul>";
    echo "<li>Adicionar coluna 'nome' na tabela usuarios</li>";
    echo "<li>Usar uma coluna existente como nome</li>";
    echo "<li>Modificar a consulta para n√£o incluir o nome do propriet√°rio</li>";
    echo "</ul>";
    echo "</div>";
}

echo "<hr>";
echo "<p><strong>‚úÖ Verifica√ß√£o da tabela usuarios conclu√≠da!</strong></p>";
?>
