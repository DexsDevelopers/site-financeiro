<?php
// verificar_remember_me_completo.php - Verifica√ß√£o completa do sistema "Lembre-se de mim"

session_start();
require_once 'includes/db_connect.php';

echo "<h2>üîç Verifica√ß√£o Completa do Sistema 'Lembre-se de mim'</h2>";

// 1. Verificar conex√£o
echo "<h3>1. Conex√£o com Banco</h3>";
try {
    $pdo->query("SELECT 1");
    echo "‚úÖ Conex√£o OK<br>";
} catch (Exception $e) {
    echo "‚ùå Erro de conex√£o: " . $e->getMessage() . "<br>";
    exit;
}

// 2. Verificar se tabela remember_tokens existe
echo "<h3>2. Verifica√ß√£o da Tabela remember_tokens</h3>";
try {
    $stmt = $pdo->query("SHOW TABLES LIKE 'remember_tokens'");
    $tableExists = $stmt->fetch();
    
    if ($tableExists) {
        echo "‚úÖ Tabela remember_tokens existe<br>";
        
        // Verificar estrutura
        $stmt = $pdo->query("DESCRIBE remember_tokens");
        $columns = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        echo "<h4>Estrutura da tabela:</h4>";
        echo "<table border='1' style='border-collapse: collapse;'>";
        echo "<tr><th>Campo</th><th>Tipo</th><th>Null</th><th>Key</th><th>Default</th><th>Extra</th></tr>";
        foreach ($columns as $column) {
            echo "<tr>";
            echo "<td>" . $column['Field'] . "</td>";
            echo "<td>" . $column['Type'] . "</td>";
            echo "<td>" . $column['Null'] . "</td>";
            echo "<td>" . $column['Key'] . "</td>";
            echo "<td>" . $column['Default'] . "</td>";
            echo "<td>" . $column['Extra'] . "</td>";
            echo "</tr>";
        }
        echo "</table>";
        
    } else {
        echo "‚ùå Tabela remember_tokens N√ÉO existe<br>";
        echo "<h4>Criando tabela...</h4>";
        
        $createTable = "
        CREATE TABLE remember_tokens (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            token VARCHAR(128) NOT NULL UNIQUE,
            expires_at DATETIME NOT NULL,
            is_active TINYINT(1) DEFAULT 1,
            user_agent TEXT,
            ip_address VARCHAR(45),
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_used_at TIMESTAMP NULL,
            INDEX idx_user_id (user_id),
            INDEX idx_token (token),
            INDEX idx_expires_at (expires_at),
            INDEX idx_is_active (is_active)
        )";
        
        $pdo->exec($createTable);
        echo "‚úÖ Tabela criada com sucesso!<br>";
    }
    
} catch (Exception $e) {
    echo "‚ùå Erro ao verificar tabela: " . $e->getMessage() . "<br>";
}

// 3. Verificar se usu√°rio est√° logado
echo "<h3>3. Status da Sess√£o</h3>";
if (isset($_SESSION['user_id'])) {
    echo "‚úÖ Usu√°rio logado: ID " . $_SESSION['user_id'] . "<br>";
    echo "Nome: " . ($_SESSION['user_name'] ?? 'N/A') . "<br>";
    echo "Email: " . ($_SESSION['user_email'] ?? 'N/A') . "<br>";
} else {
    echo "‚ùå Usu√°rio N√ÉO est√° logado<br>";
}

// 4. Verificar cookies
echo "<h3>4. Verifica√ß√£o de Cookies</h3>";
if (isset($_COOKIE['remember_token'])) {
    echo "‚úÖ Cookie remember_token encontrado: " . substr($_COOKIE['remember_token'], 0, 20) . "...<br>";
} else {
    echo "‚ùå Cookie remember_token N√ÉO encontrado<br>";
}

// 5. Testar sistema de remember me
echo "<h3>5. Teste do Sistema Remember Me</h3>";
require_once 'includes/remember_me_manager.php';

$rememberManager = new RememberMeManager($pdo);

// Verificar token do cookie
$token = $rememberManager->getTokenFromCookie();
if ($token) {
    echo "Token encontrado: " . substr($token, 0, 20) . "...<br>";
    
    // Verificar se token √© v√°lido
    $userData = $rememberManager->verifyRememberToken($token);
    if ($userData) {
        echo "‚úÖ Token V√ÅLIDO<br>";
        echo "Usu√°rio: " . $userData['nome'] . " (ID: " . $userData['id'] . ")<br>";
        echo "Expira em: " . $userData['expires_at'] . "<br>";
        echo "√öltimo uso: " . ($userData['last_used_at'] ?? 'Nunca') . "<br>";
    } else {
        echo "‚ùå Token INV√ÅLIDO ou EXPIRADO<br>";
    }
} else {
    echo "‚ùå Nenhum token encontrado no cookie<br>";
}

// 6. Estat√≠sticas dos tokens
if (isset($_SESSION['user_id'])) {
    echo "<h3>6. Estat√≠sticas dos Tokens (Usu√°rio Atual)</h3>";
    $stats = $rememberManager->getTokenStats($_SESSION['user_id']);
    if ($stats) {
        echo "Total de tokens: " . $stats['total_tokens'] . "<br>";
        echo "Tokens ativos: " . $stats['active_tokens'] . "<br>";
        echo "Tokens revogados: " . $stats['revoked_tokens'] . "<br>";
        echo "Tokens expirados: " . $stats['expired_tokens'] . "<br>";
    }
}

// 7. Teste de cria√ß√£o de token (se usu√°rio estiver logado)
if (isset($_SESSION['user_id'])) {
    echo "<h3>7. Teste de Cria√ß√£o de Token</h3>";
    
    $userAgent = $_SERVER['HTTP_USER_AGENT'] ?? 'Test Agent';
    $ipAddress = $_SERVER['REMOTE_ADDR'] ?? '127.0.0.1';
    
    $newToken = $rememberManager->createRememberToken($_SESSION['user_id'], $userAgent, $ipAddress);
    
    if ($newToken) {
        echo "‚úÖ Token criado com sucesso: " . substr($newToken, 0, 20) . "...<br>";
        
        // Verificar se token foi salvo no banco
        $userData = $rememberManager->verifyRememberToken($newToken);
        if ($userData) {
            echo "‚úÖ Token salvo e verificado com sucesso!<br>";
        } else {
            echo "‚ùå Token criado mas n√£o foi salvo corretamente<br>";
        }
    } else {
        echo "‚ùå Falha ao criar token<br>";
    }
}

// 8. Limpeza de tokens expirados
echo "<h3>8. Limpeza de Tokens Expirados</h3>";
$cleaned = $rememberManager->cleanExpiredTokens();
if ($cleaned !== false) {
    echo "‚úÖ Tokens expirados removidos: " . $cleaned . "<br>";
} else {
    echo "‚ùå Erro ao limpar tokens expirados<br>";
}

echo "<hr>";
echo "<h3>üéØ Resumo</h3>";
echo "<p><strong>Para testar o sistema:</strong></p>";
echo "<ol>";
echo "<li>Fa√ßa logout</li>";
echo "<li>Fa√ßa login marcando 'Lembre-se de mim'</li>";
echo "<li>Feche o navegador</li>";
echo "<li>Abra novamente e acesse o site</li>";
echo "<li>Deve fazer login autom√°tico</li>";
echo "</ol>";

echo "<p><a href='index.php'>‚Üê Voltar para Login</a></p>";
?>
