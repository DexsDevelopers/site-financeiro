<?php
// teste_edicao_exclusao_rotina.php - Teste das funcionalidades de editar e excluir h√°bitos

session_start();
require_once 'includes/db_connect.php';

echo "<h2>üß™ TESTE DAS FUNCIONALIDADES DE EDI√á√ÉO E EXCLUS√ÉO DE H√ÅBITOS</h2>";

// Verificar se o usu√°rio est√° logado
if (!isset($_SESSION['user_id'])) {
    echo "‚ùå Usu√°rio n√£o est√° logado. Fa√ßa login primeiro.<br>";
    echo "<a href='index.php' class='btn btn-primary'>Fazer Login</a><br><br>";
    exit();
}

echo "‚úÖ Usu√°rio logado: ID " . $_SESSION['user_id'] . "<br><br>";

// Verificar se os arquivos necess√°rios existem
echo "<h3>üîç VERIFICA√á√ÉO DOS ARQUIVOS</h3>";

$arquivos_necessarios = [
    'editar_rotina_diaria.php' => 'Arquivo para editar h√°bitos',
    'excluir_rotina_diaria.php' => 'Arquivo para excluir h√°bitos',
    'tarefas.php' => 'P√°gina principal com rotina di√°ria'
];

foreach ($arquivos_necessarios as $arquivo => $descricao) {
    if (file_exists($arquivo)) {
        echo "‚úÖ $arquivo - $descricao<br>";
    } else {
        echo "‚ùå $arquivo - $descricao (N√ÉO ENCONTRADO)<br>";
    }
}

echo "<hr>";

// Verificar estrutura da tabela rotina_diaria
echo "<h3>üìã VERIFICA√á√ÉO DA ESTRUTURA DA TABELA</h3>";

try {
    $stmt = $pdo->query("DESCRIBE rotina_diaria");
    $colunas = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    echo "‚úÖ Tabela 'rotina_diaria' existe<br>";
    echo "üìã Colunas encontradas: ";
    $nomes_colunas = array_column($colunas, 'Field');
    echo implode(', ', $nomes_colunas) . "<br>";
    
    // Verificar se as colunas necess√°rias existem
    $colunas_necessarias = ['id', 'id_usuario', 'nome', 'horario', 'status', 'data_execucao'];
    $colunas_faltando = array_diff($colunas_necessarias, $nomes_colunas);
    
    if (empty($colunas_faltando)) {
        echo "‚úÖ Todas as colunas necess√°rias existem<br>";
    } else {
        echo "‚ùå Colunas faltando: " . implode(', ', $colunas_faltando) . "<br>";
    }
    
} catch (Exception $e) {
    echo "‚ùå Erro ao verificar tabela: " . $e->getMessage() . "<br>";
}

echo "<hr>";

// Verificar h√°bitos existentes
echo "<h3>üìä VERIFICA√á√ÉO DOS H√ÅBITOS EXISTENTES</h3>";

try {
    $userId = $_SESSION['user_id'];
    $dataHoje = date('Y-m-d');
    
    // Contar h√°bitos de hoje
    $stmt = $pdo->prepare("SELECT COUNT(*) as total FROM rotina_diaria WHERE id_usuario = ? AND data_execucao = ?");
    $stmt->execute([$userId, $dataHoje]);
    $total = $stmt->fetch()['total'];
    echo "üìä Total de h√°bitos para hoje: $total<br>";
    
    if ($total > 0) {
        // Mostrar alguns h√°bitos
        $stmt = $pdo->prepare("SELECT id, nome, horario, status FROM rotina_diaria WHERE id_usuario = ? AND data_execucao = ? ORDER BY ordem LIMIT 5");
        $stmt->execute([$userId, $dataHoje]);
        $habitos = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        echo "üìã H√°bitos encontrados:<br>";
        foreach ($habitos as $habito) {
            echo "&nbsp;&nbsp;- ID: {$habito['id']}, Nome: {$habito['nome']}, Hor√°rio: " . ($habito['horario'] ?: 'N√£o definido') . ", Status: {$habito['status']}<br>";
        }
    } else {
        echo "‚ö†Ô∏è Nenhum h√°bito encontrado para hoje<br>";
        echo "üí° <a href='tarefas.php'>Acesse a p√°gina de tarefas</a> para criar h√°bitos<br>";
    }
    
} catch (Exception $e) {
    echo "‚ùå Erro ao verificar h√°bitos: " . $e->getMessage() . "<br>";
}

echo "<hr>";

// Verificar funcionalidades JavaScript
echo "<h3>üîß VERIFICA√á√ÉO DAS FUNCIONALIDADES JAVASCRIPT</h3>";

$conteudo_tarefas = file_get_contents('tarefas.php');

$funcoes_javascript = [
    'editarRotina(' => 'Fun√ß√£o para editar h√°bito',
    'excluirRotina(' => 'Fun√ß√£o para excluir h√°bito',
    'salvarEdicaoHabit()' => 'Fun√ß√£o para salvar edi√ß√£o',
    'confirmarExclusaoHabit()' => 'Fun√ß√£o para confirmar exclus√£o'
];

foreach ($funcoes_javascript as $funcao => $descricao) {
    if (strpos($conteudo_tarefas, $funcao) !== false) {
        echo "‚úÖ $descricao<br>";
    } else {
        echo "‚ùå $descricao (N√ÉO ENCONTRADA)<br>";
    }
}

echo "<hr>";

// Verificar modais
echo "<h3>üé≠ VERIFICA√á√ÉO DOS MODAIS</h3>";

$modais = [
    'modalEditarHabit' => 'Modal para editar h√°bito',
    'modalExcluirHabit' => 'Modal para excluir h√°bito'
];

foreach ($modais as $modal => $descricao) {
    if (strpos($conteudo_tarefas, $modal) !== false) {
        echo "‚úÖ $descricao<br>";
    } else {
        echo "‚ùå $descricao (N√ÉO ENCONTRADO)<br>";
    }
}

echo "<hr>";

// Verificar bot√µes de a√ß√£o
echo "<h3>üîò VERIFICA√á√ÉO DOS BOT√ïES DE A√á√ÉO</h3>";

$botoes = [
    'onclick="editarRotina(' => 'Bot√£o de editar',
    'onclick="excluirRotina(' => 'Bot√£o de excluir',
    'habit-actions' => 'Container dos bot√µes de a√ß√£o'
];

foreach ($botoes as $botao => $descricao) {
    if (strpos($conteudo_tarefas, $botao) !== false) {
        echo "‚úÖ $descricao<br>";
    } else {
        echo "‚ùå $descricao (N√ÉO ENCONTRADO)<br>";
    }
}

echo "<hr>";

// Resumo final
echo "<h2>üìä RESUMO FINAL</h2>";

$total_verificacoes = count($arquivos_necessarios) + count($funcoes_javascript) + count($modais) + count($botoes);
$verificacoes_ok = 0;

// Contar verifica√ß√µes OK
foreach ($arquivos_necessarios as $arquivo => $descricao) {
    if (file_exists($arquivo)) $verificacoes_ok++;
}

foreach ($funcoes_javascript as $funcao => $descricao) {
    if (strpos($conteudo_tarefas, $funcao) !== false) $verificacoes_ok++;
}

foreach ($modais as $modal => $descricao) {
    if (strpos($conteudo_tarefas, $modal) !== false) $verificacoes_ok++;
}

foreach ($botoes as $botao => $descricao) {
    if (strpos($conteudo_tarefas, $botao) !== false) $verificacoes_ok++;
}

echo "<p><strong>Verifica√ß√µes OK: $verificacoes_ok/$total_verificacoes</strong></p>";

if ($verificacoes_ok == $total_verificacoes) {
    echo "<div style='background: #d4edda; padding: 1rem; border-radius: 8px; margin: 1rem 0;'>";
    echo "<h4>‚úÖ Todas as funcionalidades est√£o implementadas!</h4>";
    echo "<p>As funcionalidades de editar e excluir h√°bitos est√£o prontas para uso.</p>";
    echo "<ol>";
    echo "<li><a href='tarefas.php'>Acesse a p√°gina de tarefas</a></li>";
    echo "<li>Passe o mouse sobre um h√°bito para ver os bot√µes de a√ß√£o</li>";
    echo "<li>Clique no bot√£o de editar (l√°pis) para modificar um h√°bito</li>";
    echo "<li>Clique no bot√£o de excluir (lixeira) para remover um h√°bito</li>";
    echo "</ol>";
    echo "</div>";
} else {
    echo "<div style='background: #f8d7da; padding: 1rem; border-radius: 8px; margin: 1rem 0;'>";
    echo "<h4>‚ùå Algumas funcionalidades ainda precisam ser implementadas</h4>";
    echo "<p>Verifique os itens marcados com ‚ùå acima e corrija os problemas.</p>";
    echo "</div>";
}

echo "<hr>";
echo "<p><strong>‚úÖ Teste conclu√≠do!</strong> Use as recomenda√ß√µes acima para resolver os problemas.</p>";
?>
