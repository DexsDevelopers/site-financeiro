<?php
// teste_apis_corrigidas.php - Teste das APIs ap√≥s corre√ß√µes

session_start();
require_once 'includes/db_connect.php';

echo "<h2>üß™ TESTE DAS APIs CORRIGIDAS</h2>";

// Verificar se o usu√°rio est√° logado
if (!isset($_SESSION['user_id'])) {
    echo "‚ùå Usu√°rio n√£o est√° logado. Fa√ßa login primeiro.<br>";
    echo "<a href='index.php' class='btn btn-primary'>Fazer Login</a><br><br>";
    exit();
}

echo "‚úÖ Usu√°rio logado: ID " . $_SESSION['user_id'] . "<br><br>";

// Fun√ß√£o para testar API com melhor tratamento de erros
function testarAPICorrigida($nome, $url) {
    echo "<h3>üîç Teste: $nome</h3>";
    echo "URL: $url<br>";
    
    try {
        // Configurar contexto HTTP
        $context = stream_context_create([
            'http' => [
                'method' => 'GET',
                'header' => [
                    'Content-Type: application/json',
                    'Accept: application/json',
                    'User-Agent: Mozilla/5.0 (compatible; API-Test)'
                ],
                'timeout' => 30,
                'ignore_errors' => true
            ]
        ]);
        
        $response = file_get_contents($url, false, $context);
        
        if ($response === false) {
            echo "‚ùå Erro ao acessar a API<br>";
            return false;
        }
        
        echo "‚úÖ Resposta recebida (tamanho: " . strlen($response) . " bytes)<br>";
        
        // Verificar se a resposta n√£o est√° vazia
        if (empty(trim($response))) {
            echo "‚ùå Resposta vazia<br>";
            return false;
        }
        
        // Mostrar primeiros 200 caracteres da resposta
        echo "Primeiros 200 caracteres: " . htmlspecialchars(substr($response, 0, 200)) . "...<br>";
        
        // Tentar decodificar JSON
        $data = json_decode($response, true);
        
        if ($data === null) {
            echo "‚ùå Resposta n√£o √© JSON v√°lido<br>";
            echo "Erro JSON: " . json_last_error_msg() . "<br>";
            echo "Resposta completa: " . htmlspecialchars($response) . "<br>";
            return false;
        }
        
        echo "‚úÖ JSON v√°lido<br>";
        echo "Dados decodificados:<br>";
        echo "<pre>" . json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "</pre>";
        
        if (isset($data['success']) && $data['success'] === true) {
            echo "‚úÖ API funcionando corretamente<br>";
            return true;
        } else {
            echo "‚ùå API retornou erro: " . ($data['message'] ?? 'Erro desconhecido') . "<br>";
            return false;
        }
        
    } catch (Exception $e) {
        echo "‚ùå Erro ao testar API: " . $e->getMessage() . "<br>";
        return false;
    }
}

// Testar cada API
$baseUrl = "http://" . $_SERVER['HTTP_HOST'] . dirname($_SERVER['REQUEST_URI']);
$resultados = [];

echo "<h2>üìä RESULTADOS DOS TESTES</h2>";

$resultados['tarefas_hoje'] = testarAPICorrigida("Tarefas de Hoje", $baseUrl . "/buscar_tarefas_hoje.php");
echo "<hr>";

$resultados['distribuicao'] = testarAPICorrigida("Distribui√ß√£o por Prioridade", $baseUrl . "/buscar_distribuicao_prioridade.php");
echo "<hr>";

$resultados['produtividade'] = testarAPICorrigida("Produtividade 7 Dias", $baseUrl . "/buscar_produtividade_7_dias.php");
echo "<hr>";

// Resumo dos resultados
echo "<h2>üìã RESUMO DOS RESULTADOS</h2>";
$sucessos = 0;
$total = count($resultados);

foreach ($resultados as $nome => $sucesso) {
    if ($sucesso) {
        echo "‚úÖ $nome: FUNCIONANDO<br>";
        $sucessos++;
    } else {
        echo "‚ùå $nome: COM PROBLEMAS<br>";
    }
}

echo "<br><strong>Total: $sucessos/$total APIs funcionando</strong><br>";

if ($sucessos === $total) {
    echo "<br><h3>üéâ PARAB√âNS! Todas as APIs est√£o funcionando!</h3>";
    echo "O sistema de estat√≠sticas est√° funcionando corretamente.<br>";
    echo "<a href='tarefas.php' class='btn btn-success'>Voltar para Tarefas</a>";
} else {
    echo "<br><h3>‚ö†Ô∏è Ainda h√° problemas</h3>";
    echo "Algumas APIs ainda n√£o est√£o funcionando. Verifique:<br>";
    echo "1. Se h√° tarefas no banco de dados<br>";
    echo "2. Se o usu√°rio est√° logado corretamente<br>";
    echo "3. Se h√° erros nos logs do servidor<br>";
    echo "<br><a href='corrigir_estatisticas.php' class='btn btn-warning'>Executar Corre√ß√£o Autom√°tica</a>";
}

// Teste adicional: verificar se as tabelas existem
echo "<h3>üîç VERIFICA√á√ÉO ADICIONAL DO BANCO</h3>";
try {
    $stmt = $pdo->query("SHOW TABLES LIKE 'tarefas'");
    if ($stmt->fetch()) {
        echo "‚úÖ Tabela 'tarefas' existe<br>";
        
        // Verificar se h√° dados
        $stmt = $pdo->prepare("SELECT COUNT(*) as total FROM tarefas WHERE id_usuario = ?");
        $stmt->execute([$_SESSION['user_id']]);
        $total = $stmt->fetch()['total'];
        echo "üìä Total de tarefas do usu√°rio: $total<br>";
        
        if ($total == 0) {
            echo "‚ö†Ô∏è Nenhuma tarefa encontrada. Isso pode causar problemas nas APIs.<br>";
        }
    } else {
        echo "‚ùå Tabela 'tarefas' n√£o existe<br>";
    }
} catch (Exception $e) {
    echo "‚ùå Erro ao verificar banco: " . $e->getMessage() . "<br>";
}
?>
