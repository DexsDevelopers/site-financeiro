<?php
// teste_apis_alternativas.php - Teste das APIs alternativas sem redirecionamento

session_start();
require_once 'includes/db_connect.php';

echo "<h2>üß™ TESTE DAS APIs ALTERNATIVAS</h2>";

// Verificar se o usu√°rio est√° logado
if (!isset($_SESSION['user_id'])) {
    echo "‚ùå Usu√°rio n√£o est√° logado. Fa√ßa login primeiro.<br>";
    echo "<a href='index.php' class='btn btn-primary'>Fazer Login</a><br><br>";
    exit();
}

echo "‚úÖ Usu√°rio logado: ID " . $_SESSION['user_id'] . "<br><br>";

// Fun√ß√£o para testar API alternativa
function testarAPIAlternativa($nome, $arquivo) {
    echo "<h3>üîç Teste: $nome</h3>";
    echo "Arquivo: $arquivo<br>";
    
    if (!file_exists($arquivo)) {
        echo "‚ùå Arquivo n√£o encontrado<br>";
        return false;
    }
    
    echo "‚úÖ Arquivo existe<br>";
    
    // Capturar output
    ob_start();
    
    try {
        // Simular execu√ß√£o direta
        $_SERVER['REQUEST_METHOD'] = 'GET';
        $_SERVER['HTTP_HOST'] = $_SERVER['HTTP_HOST'];
        $_SERVER['REQUEST_URI'] = '/' . $arquivo;
        
        include $arquivo;
        $output = ob_get_clean();
        
        if (!empty($output)) {
            echo "‚úÖ Output capturado (tamanho: " . strlen($output) . " bytes)<br>";
            
            // Verificar se √© JSON v√°lido
            $data = json_decode($output, true);
            if ($data !== null) {
                echo "‚úÖ JSON v√°lido<br>";
                echo "Dados: " . json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "<br>";
                
                if (isset($data['success']) && $data['success'] === true) {
                    echo "‚úÖ API funcionando corretamente<br>";
                    return true;
                } else {
                    echo "‚ùå API retornou erro: " . ($data['message'] ?? 'Erro desconhecido') . "<br>";
                }
            } else {
                echo "‚ùå JSON inv√°lido: " . json_last_error_msg() . "<br>";
                echo "Output: " . htmlspecialchars($output) . "<br>";
            }
        } else {
            echo "‚ùå Nenhum output capturado<br>";
        }
    } catch (Exception $e) {
        ob_end_clean();
        echo "‚ùå Erro: " . $e->getMessage() . "<br>";
    }
    
    return false;
}

// Testar cada API alternativa
echo "<h2>üìä TESTE DAS APIs ALTERNATIVAS</h2>";

$apis = [
    'api_tarefas_hoje.php' => 'Tarefas de Hoje (Alternativa)',
    'api_distribuicao_prioridade.php' => 'Distribui√ß√£o por Prioridade (Alternativa)',
    'api_produtividade_7_dias.php' => 'Produtividade 7 Dias (Alternativa)'
];

$resultados = [];

foreach ($apis as $arquivo => $nome) {
    $resultados[$arquivo] = testarAPIAlternativa($nome, $arquivo);
    echo "<hr>";
}

// Resumo
echo "<h2>üìã RESUMO DOS RESULTADOS</h2>";
$sucessos = 0;
$total = count($resultados);

foreach ($resultados as $arquivo => $sucesso) {
    if ($sucesso) {
        echo "‚úÖ $arquivo: FUNCIONANDO<br>";
        $sucessos++;
    } else {
        echo "‚ùå $arquivo: COM PROBLEMAS<br>";
    }
}

echo "<br><strong>Total: $sucessos/$total APIs funcionando</strong><br>";

// Verifica√ß√µes adicionais
echo "<h3>üîç VERIFICA√á√ïES ADICIONAIS</h3>";

// Verificar se as tabelas existem
try {
    $stmt = $pdo->query("SHOW TABLES LIKE 'tarefas'");
    if ($stmt->fetch()) {
        echo "‚úÖ Tabela 'tarefas' existe<br>";
        
        // Verificar se h√° dados
        $stmt = $pdo->prepare("SELECT COUNT(*) as total FROM tarefas WHERE id_usuario = ?");
        $stmt->execute([$_SESSION['user_id']]);
        $total = $stmt->fetch()['total'];
        echo "üìä Total de tarefas: $total<br>";
        
        if ($total == 0) {
            echo "‚ö†Ô∏è Nenhuma tarefa encontrada. Isso pode causar problemas nas APIs.<br>";
        }
    } else {
        echo "‚ùå Tabela 'tarefas' n√£o existe<br>";
    }
} catch (Exception $e) {
    echo "‚ùå Erro ao verificar banco: " . $e->getMessage() . "<br>";
}

// Verificar configura√ß√£o PHP
echo "<h3>‚öôÔ∏è CONFIGURA√á√ÉO PHP</h3>";
echo "Vers√£o PHP: " . phpversion() . "<br>";
echo "JSON support: " . (function_exists('json_encode') ? 'Sim' : 'N√£o') . "<br>";
echo "PDO support: " . (class_exists('PDO') ? 'Sim' : 'N√£o') . "<br>";
echo "Session support: " . (function_exists('session_start') ? 'Sim' : 'N√£o') . "<br>";

if ($sucessos === $total) {
    echo "<br><h3>üéâ TODAS AS APIs ALTERNATIVAS EST√ÉO FUNCIONANDO!</h3>";
    echo "<p>As APIs alternativas funcionam corretamente. Agora voc√™ pode:</p>";
    echo "<ul>";
    echo "<li>Usar as APIs alternativas no lugar das originais</li>";
    echo "<li>Atualizar o JavaScript para usar as novas URLs</li>";
    echo "<li>Testar o modal de estat√≠sticas</li>";
    echo "</ul>";
    echo "<a href='tarefas.php' class='btn btn-success'>Voltar para Tarefas</a>";
} else {
    echo "<br><h3>‚ö†Ô∏è AINDA H√Å PROBLEMAS</h3>";
    echo "Algumas APIs alternativas ainda n√£o est√£o funcionando. Verifique:<br>";
    echo "<ul>";
    echo "<li>Se h√° tarefas no banco de dados</li>";
    echo "<li>Se o usu√°rio est√° logado corretamente</li>";
    echo "<li>Se h√° erros nos logs do servidor</li>";
    echo "<li>Se as permiss√µes dos arquivos est√£o corretas</li>";
    echo "</ul>";
}
?>
