<?php
// teste_organizacao_horario_final.php - Teste final da p√°gina Organiza√ß√£o por Hor√°rio
echo "<h1>üß™ Teste Final - P√°gina Organiza√ß√£o por Hor√°rio</h1>";
echo "<hr>";

// 1. Verificar se o usu√°rio est√° logado
session_start();
if (!isset($_SESSION['user_id'])) {
    echo "<div style='background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0;'>";
    echo "‚ùå <strong>Usu√°rio n√£o logado!</strong><br>";
    echo "Para testar a p√°gina, voc√™ precisa estar logado. <a href='index.php'>Clique aqui para fazer login</a>";
    echo "</div>";
    exit();
}

echo "<div style='background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0;'>";
echo "‚úÖ <strong>Usu√°rio logado:</strong> ID " . $_SESSION['user_id'];
echo "</div>";

// 2. Verificar depend√™ncias
echo "<h2>2. Verifica√ß√£o de Depend√™ncias</h2>";

$dependencies = [
    'templates/header.php' => 'Header template',
    'templates/footer.php' => 'Footer template',
    'includes/db_connect.php' => 'Conex√£o com banco',
    'concluir_tarefa_ajax.php' => 'Script de conclus√£o de tarefas'
];

foreach ($dependencies as $file => $description) {
    if (file_exists($file)) {
        echo "‚úÖ <strong>$description</strong> ($file) - <span style='color: green;'>EXISTE</span><br>";
    } else {
        echo "‚ùå <strong>$description</strong> ($file) - <span style='color: red;'>N√ÉO EXISTE</span><br>";
    }
}

// 3. Testar conex√£o com banco
echo "<br><h2>3. Teste de Conex√£o com Banco de Dados</h2>";
try {
    require_once 'includes/db_connect.php';
    if (isset($pdo) && $pdo instanceof PDO) {
        echo "‚úÖ <span style='color: green;'>Conex√£o com banco estabelecida</span><br>";
        
        // Testar consulta simples
        $stmt = $pdo->query("SELECT 1 as test");
        if ($stmt) {
            echo "‚úÖ <span style='color: green;'>Consulta de teste bem-sucedida</span><br>";
        }
    } else {
        echo "‚ùå <span style='color: red;'>Conex√£o com banco falhou</span><br>";
    }
} catch (Exception $e) {
    echo "‚ùå <span style='color: red;'>Erro de conex√£o: " . $e->getMessage() . "</span><br>";
}

// 4. Testar a p√°gina diretamente
echo "<br><h2>4. Teste de Acesso √† P√°gina</h2>";
echo "<div style='background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 10px 0;'>";
echo "<strong>üîó Links de Teste:</strong><br>";
echo "‚Ä¢ <a href='automatizacao_horario.php' target='_blank'>Abrir p√°gina em nova aba</a><br>";
echo "‚Ä¢ <a href='automatizacao_horario.php' target='_self'>Abrir p√°gina na mesma aba</a><br>";
echo "</div>";

// 5. Verificar estrutura da tabela tarefas
echo "<br><h2>5. Verifica√ß√£o da Estrutura da Tabela</h2>";
try {
    if (isset($pdo)) {
        $stmt = $pdo->query("DESCRIBE tarefas");
        $columns = $stmt->fetchAll();
        
        $requiredColumns = ['id', 'descricao', 'prioridade', 'status', 'hora_inicio', 'data_criacao', 'id_usuario'];
        
        foreach ($requiredColumns as $col) {
            $found = false;
            foreach ($columns as $column) {
                if ($column['Field'] === $col) {
                    $found = true;
                    break;
                }
            }
            
            if ($found) {
                echo "‚úÖ Coluna <strong>$col</strong> - <span style='color: green;'>EXISTE</span><br>";
            } else {
                echo "‚ùå Coluna <strong>$col</strong> - <span style='color: red;'>N√ÉO EXISTE</span><br>";
            }
        }
    }
} catch (Exception $e) {
    echo "‚ùå <span style='color: red;'>Erro ao verificar estrutura: " . $e->getMessage() . "</span><br>";
}

// 6. Testar JavaScript
echo "<br><h2>6. Teste de JavaScript</h2>";
echo "<div style='background: #fff3cd; padding: 15px; border-radius: 5px; margin: 10px 0;'>";
echo "<strong>üìã Para testar o JavaScript:</strong><br>";
echo "1. Abra a p√°gina <a href='automatizacao_horario.php' target='_blank'>automatizacao_horario.php</a><br>";
echo "2. Pressione F12 para abrir o console do navegador<br>";
echo "3. Verifique se h√° erros JavaScript<br>";
echo "4. Teste clicar em uma tarefa para conclu√≠-la<br>";
echo "</div>";

// 7. Instru√ß√µes de debug
echo "<br><h2>7. Instru√ß√µes de Debug</h2>";
echo "<div style='background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff;'>";
echo "<h4>üîß Se a p√°gina n√£o estiver funcionando:</h4>";
echo "<ol>";
echo "<li><strong>Verifique o console do navegador (F12):</strong> Procure por erros JavaScript</li>";
echo "<li><strong>Verifique os logs do servidor:</strong> Procure por erros PHP</li>";
echo "<li><strong>Teste em modo inc√≥gnito:</strong> Para descartar problemas de cache</li>";
echo "<li><strong>Verifique as permiss√µes:</strong> Certifique-se de que o arquivo tem permiss√£o de leitura</li>";
echo "<li><strong>Verifique a configura√ß√£o do servidor:</strong> Certifique-se de que o PHP est√° funcionando</li>";
echo "</ol>";
echo "</div>";

// 8. Status final
echo "<br><h2>8. Status Final</h2>";
$currentTime = date('Y-m-d H:i:s');
echo "‚è∞ <strong>Hora do teste:</strong> $currentTime<br>";

if (file_exists('automatizacao_horario.php')) {
    $fileSize = filesize('automatizacao_horario.php');
    echo "üìÑ <strong>Tamanho do arquivo:</strong> " . number_format($fileSize) . " bytes<br>";
}

echo "<br><div style='background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 10px 0;'>";
echo "<strong>üéØ Pr√≥ximo passo:</strong> Se todos os itens acima estiverem ‚úÖ, a p√°gina deve estar funcionando. ";
echo "Se ainda houver problemas, verifique os logs do servidor para mais detalhes.";
echo "</div>";
?>
